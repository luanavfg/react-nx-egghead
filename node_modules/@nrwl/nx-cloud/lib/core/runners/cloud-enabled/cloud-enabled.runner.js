const a1_0x267e=['extractGitSha','length','anyErrors','endRun','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','ErrorReporterApi','https://nx.app','scan','message','error','cacheableOperations','hash','FileStorage','AGENT_RUNNING_IN_DISTRIBUTED_EXECUTION','__awaiter','./cloud-remote-cache','exit','daemon','../../terminal-output/output-obfuscator','value','getRunGroup','MessageReporter','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','api.nrwl.io','waitForStoreRequestsToComplete','generateUniqueLinkId','Nx\x20Cloud\x20Problems','../../../utilities/environment','endsWith','then','CloudRunApi','assign','subscribe','EndOfRunMessage','tasks-hashes-','E2EEncryption','@nrwl/nx-cloud/lib/daemon/process-run-end','ACCESS_TOKEN','uploads','VERBOSE_LOGGING','fs-extra','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','rxjs/internal/Subject','maskedProperties','__esModule','printMessages','toISOString','cloudEnabledTasksRunner','indexOf','getMachineInfo','../../../utilities/nx-imports','writeFileSync','./cloud-enabled-life-cycle','./id-generator','toString','ENCRYPTION_KEY','done','accessToken','../../api/error-reporter.api','map','OutputObfuscator','localhost','lifeCycle','processInBackground','../../file-storage/file-storage','pathExists','../../terminal-output/end-of-run-message','path','CloudEnabledLifeCycle','submitRunMetrics','.commit','url','printCacheHitsMessage','startRun','/runs/','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','taskId','join','next','stringify','apply','getNxCacheDirectory','encryptionKey','requests'];(function(_0xc0fd75,_0x267e2b){const _0xa02b7e=function(_0x1b15f1){while(--_0x1b15f1){_0xc0fd75['push'](_0xc0fd75['shift']());}};_0xa02b7e(++_0x267e2b);}(a1_0x267e,0x96));const a1_0xa02b=function(_0xc0fd75,_0x267e2b){_0xc0fd75=_0xc0fd75-0x0;let _0xa02b7e=a1_0x267e[_0xc0fd75];return _0xa02b7e;};'use strict';var __awaiter=this&&this[a1_0xa02b('0x20')]||function(_0x5cea15,_0x42aa0e,_0x3c841f,_0x2f2508){function _0x3a9bd3(_0x548f68){return _0x548f68 instanceof _0x3c841f?_0x548f68:new _0x3c841f(function(_0x218720){_0x218720(_0x548f68);});}return new(_0x3c841f||(_0x3c841f=Promise))(function(_0x27815f,_0x5cc34c){function _0x19eb9(_0x7bbcb8){try{_0x30788c(_0x2f2508[a1_0xa02b('0xc')](_0x7bbcb8));}catch(_0x3166a0){_0x5cc34c(_0x3166a0);}}function _0x271b8f(_0x48ba12){try{_0x30788c(_0x2f2508['throw'](_0x48ba12));}catch(_0x3509b1){_0x5cc34c(_0x3509b1);}}function _0x30788c(_0x3d0c7b){_0x3d0c7b[a1_0xa02b('0x4a')]?_0x27815f(_0x3d0c7b[a1_0xa02b('0x25')]):_0x3a9bd3(_0x3d0c7b[a1_0xa02b('0x25')])[a1_0xa02b('0x2f')](_0x19eb9,_0x271b8f);}_0x30788c((_0x2f2508=_0x2f2508[a1_0xa02b('0xe')](_0x5cea15,_0x42aa0e||[]))['next']());});};Object['defineProperty'](exports,a1_0xa02b('0x3e'),{'value':!![]});exports['cloudEnabledTasksRunner']=void 0x0;const message_reporter_1=require('../../terminal-output/message-reporter');const end_of_run_message_1=require(a1_0xa02b('0x0'));const output_obfuscator_1=require(a1_0xa02b('0x24'));const cloud_enabled_life_cycle_1=require(a1_0xa02b('0x46'));const file_storage_1=require(a1_0xa02b('0x52'));const e2e_encryption_1=require('../../file-storage/e2e-encryption');const environment_1=require(a1_0xa02b('0x2d'));const cloud_remote_cache_1=require(a1_0xa02b('0x21'));const cloud_run_api_1=require('./cloud-run.api');const fs_1=require('fs');const path=require(a1_0xa02b('0x1'));const metric_logger_1=require('../../../utilities/metric-logger');const error_reporter_api_1=require(a1_0xa02b('0x4c'));const path_1=require(a1_0xa02b('0x1'));const fs_extra_1=require(a1_0xa02b('0x3a'));const id_generator_1=require(a1_0xa02b('0x47'));const {tasksRunner,output,Cache}=require(a1_0xa02b('0x44'));function createApi(_0x1d2264,_0x360ac0,_0x59cc14){const _0x22ebf1=(0x0,environment_1[a1_0xa02b('0x43')])(_0x360ac0);return new cloud_run_api_1[(a1_0xa02b('0x30'))](_0x1d2264,_0x59cc14,_0x360ac0,_0x22ebf1);}function storeTaskHashes(_0x416548,_0x469c97,_0x58675e){const _0x489fe7=JSON[a1_0xa02b('0xd')](_0x416548[a1_0xa02b('0x4d')](_0x27b57c=>({'taskId':_0x27b57c[a1_0xa02b('0xa')],'hash':_0x27b57c[a1_0xa02b('0x1d')]})));if(environment_1[a1_0xa02b('0x39')]){output['note']({'title':'Executed\x20tasks\x20with\x20hashes:\x20'+_0x489fe7});}(0x0,fs_1[a1_0xa02b('0x45')])(path[a1_0xa02b('0xb')](_0x469c97,a1_0xa02b('0x34')+_0x58675e),_0x489fe7);}function onComplete({daemon,lifeCycle,options,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,fileStorage,uploadInCurrentProcess,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0xaa5409=new Date()[a1_0xa02b('0x40')]();const _0x480113=(0x0,environment_1['getBranch'])();const _0x2f3a32={'command':outputObfuscator['obfuscate']((0x0,environment_1['parseCommand'])()),'startTime':runStartTime,'endTime':_0xaa5409,'distributedExecutionId':environment_1['NX_CLOUD_DISTRIBUTED_EXECUTION_ID'],'branch':_0x480113,'scan':!![],'runGroup':(0x0,environment_1[a1_0xa02b('0x26')])(),'sha':_0x480113?(0x0,environment_1[a1_0xa02b('0x12')])():undefined,'inner':inner};if(uploadInCurrentProcess){if(environment_1['AGENT_RUNNING_IN_DISTRIBUTED_EXECUTION']){storeTaskHashes(taskExecutions,(0x0,environment_1[a1_0xa02b('0xf')])(options),environment_1[a1_0xa02b('0x9')]);}try{yield remoteCache[a1_0xa02b('0x2a')]();}catch(_0xa626a3){output[a1_0xa02b('0x1b')]({'title':a1_0xa02b('0x3b')});messages[a1_0xa02b('0x3f')]();process[a1_0xa02b('0x22')](environment_1[a1_0xa02b('0x16')]);}try{yield api[a1_0xa02b('0x15')](_0x2f3a32,taskExecutions);}catch(_0x109d2c){output[a1_0xa02b('0x1b')]({'title':a1_0xa02b('0x28')});messages[a1_0xa02b('0x3f')]();process[a1_0xa02b('0x22')](environment_1[a1_0xa02b('0x16')]);}yield(0x0,metric_logger_1[a1_0xa02b('0x3')])(options);}else{try{const _0x2f2821=environment_1[a1_0xa02b('0x37')]?environment_1[a1_0xa02b('0x37')]:options[a1_0xa02b('0x4b')];const _0x17e8ae=(0x0,id_generator_1[a1_0xa02b('0x2b')])();yield daemon[a1_0xa02b('0x51')](a1_0xa02b('0x36'),{'encryptionKey':encryptionKey,'runnerOptions':Object['assign'](Object['assign']({},options),{'accessToken':_0x2f2821}),'uploads':fileStorage[a1_0xa02b('0x38')],'runEnd':{'runData':_0x2f3a32,'taskExecutions':taskExecutions,'linkId':_0x17e8ae}});runContext['runUrl']=(options['url']||a1_0xa02b('0x18'))+a1_0xa02b('0x8')+_0x17e8ae;}catch(_0x230f9b){output['warn']({'title':a1_0xa02b('0x2c'),'bodyLines':[_0x230f9b[a1_0xa02b('0x1a')]||_0x230f9b[a1_0xa02b('0x48')]()]});}}if(versionOfNxBefore133){setTimeout(()=>{messages['printMessages']();if(!messages[a1_0xa02b('0x14')]&&!inner){endOfRunMessage['printCacheHitsMessage']();}},0x0);}else{messages['printMessages']();if(!messages[a1_0xa02b('0x14')]&&!inner){endOfRunMessage[a1_0xa02b('0x6')]();}}});}function createLifeCycle(_0x3ef408,_0x1c1bd,_0x494b32,_0x161e6b){const _0x174a8a=new cloud_enabled_life_cycle_1[(a1_0xa02b('0x2'))](_0x3ef408,(0x0,environment_1[a1_0xa02b('0xf')])(_0x1c1bd),!!_0x1c1bd['skipNxCache'],_0x1c1bd[a1_0xa02b('0x19')]===undefined?!![]:_0x1c1bd['scan'],_0x1c1bd[a1_0xa02b('0x1c')]||[],_0x494b32,_0x161e6b);try{const {CompositeLifeCycle}=require(a1_0xa02b('0x44'));if(!CompositeLifeCycle)return _0x174a8a;return new CompositeLifeCycle([_0x1c1bd[a1_0xa02b('0x50')],_0x174a8a]);}catch(_0x281f9b){return _0x174a8a;}}function fetchUrlsForKnownHashesUpfront(_0x696dbb,_0x1bc468,_0x314387,_0x2bdfd0){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x26aa9d=_0x314387[a1_0xa02b('0x4d')](_0x1f7c69=>_0x1f7c69[a1_0xa02b('0x1d')])['filter'](_0x2bd594=>!!_0x2bd594);const _0x339f81=new Cache(_0x2bdfd0);if(!_0x2bdfd0['skipNxCache']){const _0x197da7=yield Promise['all'](_0x26aa9d[a1_0xa02b('0x4d')](_0x1a68da=>{const _0x1ecd9e=(0x0,path_1[a1_0xa02b('0xb')])(_0x339f81['cachePath'],_0x1a68da+a1_0xa02b('0x4'));return(0x0,fs_extra_1[a1_0xa02b('0x53')])(_0x1ecd9e);}));const _0x30079=[];for(let _0x4c596f=0x0;_0x4c596f<_0x197da7[a1_0xa02b('0x13')];++_0x4c596f){if(_0x197da7[_0x4c596f]){_0x30079['push'](_0x26aa9d[_0x4c596f]);}}_0x26aa9d=_0x30079;}if(_0x26aa9d[a1_0xa02b('0x13')]>0x0){const _0x3190e1=_0x696dbb[a1_0xa02b('0x7')](environment_1[a1_0xa02b('0x9')],_0x26aa9d);for(const _0x21ce05 of _0x26aa9d){_0x1bc468[a1_0xa02b('0x11')][_0x21ce05]=_0x3190e1;}}});}function isConnectedToPrivateCloud(_0x4eea66){if(!_0x4eea66['url'])return![];if(_0x4eea66[a1_0xa02b('0x5')][a1_0xa02b('0x2e')](a1_0xa02b('0x29')))return![];if(_0x4eea66[a1_0xa02b('0x5')]['endsWith']('.nx.app'))return![];if(_0x4eea66[a1_0xa02b('0x5')][a1_0xa02b('0x42')](a1_0xa02b('0x4f'))>-0x1)return![];return!![];}function cloudEnabledTasksRunner(_0x10ca0f,_0x52dece,_0x240e9a,_0x1b2a82=![]){var _0x42f7ca;const _0x1d4622={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x10ca0f};const _0x2b0242=_0x52dece[a1_0xa02b('0x50')]===undefined;const _0xcaac61=[];const _0x168bad=new message_reporter_1[(a1_0xa02b('0x27'))](_0x52dece);const _0x19a60e=createApi(_0x168bad,_0x52dece,_0x1d4622);const _0x15089a=new end_of_run_message_1[(a1_0xa02b('0x33'))](_0x1d4622,_0xcaac61);const _0x2b1c3c=new output_obfuscator_1[(a1_0xa02b('0x4e'))](_0x52dece[a1_0xa02b('0x3d')]);const _0x675dc6=new Date()['toISOString']();const _0x43cfa2=createLifeCycle(_0x1d4622,_0x52dece,_0x2b1c3c,_0xcaac61);const _0x3624f2=environment_1[a1_0xa02b('0x49')]||_0x52dece[a1_0xa02b('0x10')];const _0xb133f9=new e2e_encryption_1[(a1_0xa02b('0x35'))](_0x3624f2);const _0x474140=new error_reporter_api_1[(a1_0xa02b('0x17'))](_0x52dece);const _0x3e8eff=!!environment_1[a1_0xa02b('0x1f')]||!((_0x42f7ca=_0x240e9a[a1_0xa02b('0x23')])===null||_0x42f7ca===void 0x0?void 0x0:_0x42f7ca['enabled']())||isConnectedToPrivateCloud(_0x52dece);const _0x57548d=new file_storage_1[(a1_0xa02b('0x1e'))](_0xb133f9,_0x474140,![],_0x3e8eff);const _0x27d1d9=new cloud_remote_cache_1['CloudRemoteCache'](_0x168bad,_0x19a60e,_0x1d4622,_0x57548d);fetchUrlsForKnownHashesUpfront(_0x19a60e,_0x1d4622,_0x10ca0f,_0x52dece);delete process['env'][a1_0xa02b('0x9')];const _0x5797ef=tasksRunner(_0x10ca0f,Object[a1_0xa02b('0x31')](Object[a1_0xa02b('0x31')]({},_0x52dece),{'remoteCache':_0x27d1d9,'lifeCycle':_0x43cfa2}),_0x240e9a);if(_0x5797ef[a1_0xa02b('0x32')]){const {Subject}=require(a1_0xa02b('0x3c'));const _0x5a8fe2=new Subject();_0x5797ef[a1_0xa02b('0x32')]({'next':_0x376805=>_0x5a8fe2[a1_0xa02b('0xc')](_0x376805),'error':_0x4d7d8b=>_0x5a8fe2['error'](_0x4d7d8b),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x240e9a[a1_0xa02b('0x23')],'lifeCycle':_0x43cfa2,'options':_0x52dece,'remoteCache':_0x27d1d9,'api':_0x19a60e,'outputObfuscator':_0x2b1c3c,'runStartTime':_0x675dc6,'messages':_0x168bad,'endOfRunMessage':_0x15089a,'taskExecutions':_0xcaac61,'versionOfNxBefore133':_0x2b0242,'inner':_0x1b2a82,'encryptionKey':_0x3624f2,'fileStorage':_0x57548d,'uploadInCurrentProcess':_0x3e8eff,'runContext':_0x1d4622});_0x5a8fe2['complete']();})});return _0x5a8fe2;}else{return _0x5797ef['then'](_0x19b7dd=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x240e9a[a1_0xa02b('0x23')],'lifeCycle':_0x43cfa2,'options':_0x52dece,'remoteCache':_0x27d1d9,'api':_0x19a60e,'outputObfuscator':_0x2b1c3c,'runStartTime':_0x675dc6,'messages':_0x168bad,'endOfRunMessage':_0x15089a,'taskExecutions':_0xcaac61,'versionOfNxBefore133':_0x2b0242,'inner':_0x1b2a82,'encryptionKey':_0x3624f2,'fileStorage':_0x57548d,'uploadInCurrentProcess':_0x3e8eff,'runContext':_0x1d4622});return _0x19b7dd;}))['catch'](_0x21336e=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x240e9a[a1_0xa02b('0x23')],'lifeCycle':_0x43cfa2,'options':_0x52dece,'remoteCache':_0x27d1d9,'api':_0x19a60e,'outputObfuscator':_0x2b1c3c,'runStartTime':_0x675dc6,'messages':_0x168bad,'endOfRunMessage':_0x15089a,'taskExecutions':_0xcaac61,'versionOfNxBefore133':_0x2b0242,'inner':_0x1b2a82,'encryptionKey':_0x3624f2,'fileStorage':_0x57548d,'uploadInCurrentProcess':_0x3e8eff,'runContext':_0x1d4622});throw _0x21336e;}));}}exports[a1_0xa02b('0x41')]=cloudEnabledTasksRunner;